name: pve-kernel去分区内核编译

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    name: 编译 "${{matrix.platform}} ${{matrix.version}}"
    strategy:
      fail-fast: false

    steps:
      - name: 缓存加速
        uses: actions/cache@v2
        with:
          path: |
            ./submodules/*
          key: my-key-toyarmy-build-uniommu
    
      - name: clone proxmox/pve-kernel
        run: |
          # git clone https://github.com/proxmox/pve-kernel.git
          git clone -b pve-kernel-5.13 https://github.com/proxmox/pve-kernel.git
          # git clone git://git.proxmox.com/git/pve-kernel.git
          # cd ./pve-kernel/submodules
          git clone git://kernel.ubuntu.com/ubuntu/ubuntu-impish.git ./pve-kernel/submodules/ubuntu-impish/
          # git clone https://github.com/zfsonlinux/zfs-auto-snapshot.git ./pve-kernel/submodules/zfsonlinux/
          echo "克隆完成"
        
        
      - name: 拷贝文件
        run: |
          mv ./pve-kernel/* ./
          rm -rf ./pve-kernel
          rm -rf ./submodules/zfsonlinux
        

      - name: 准备构建环境
        run: |
          sudo apt-get install dpkg-dev
          rm -rf ./patches/kernel/0003-pci-Enable-overrides-for-missing-ACS-capabilities-4..patch
          sudo curl -o ./patches/kernel/0003-pci-Enable-overrides-for-missing-ACS-capabilities-4..patch https://raw.githubusercontent.com/ybin116/build_pve_kernel_unIOMMU/main/0003-pci-Enable-overrides-for-missing-ACS-capabilities-4..patch
          # curl -O https://raw.githubusercontent.com/ybin116/build_pve_kernel_unIOMMU/main/0003-pci-Enable-overrides-for-missing-ACS-capabilities-4..patch
          # mv 0003-pci-Enable-overrides-for-missing-ACS-capabilities-4..patch ./patches/kernel/
          
      - name: 编译
        run: |
          sudo make


      - name: 上传引导镜像到 github actions
        uses: actions/upload-artifact@v2
        with:
          name: pve-kernel
          path: ./*.deb
       #   path: ./pve-kernel/*
          if-no-files-found: error
